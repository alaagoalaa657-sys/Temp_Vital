@page "/patients/{id:int}"
@using Vital.BusinessLogic.Managers
@using Vital.Domain.Entities
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject PatientManager PatientManager
@inject AppointmentManager AppointmentManager
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Patient Details - Vital Clinic</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/patients" class="btn btn-outline-secondary btn-sm mb-2">
                <i class="bi bi-arrow-left"></i> Back to Patients
            </a>
            <h2>Patient Details</h2>
        </div>
        @if (!isEditing)
        {
            <button class="btn btn-primary" @onclick="EnableEdit">
                <i class="bi bi-pencil"></i> Edit
            </button>
        }
    </div>

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (patient == null)
    {
        <div class="alert alert-warning">Patient not found</div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @successMessage
                <button type="button" class="btn-close" @onclick="@(() => successMessage = string.Empty)"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @errorMessage
                <button type="button" class="btn-close" @onclick="@(() => errorMessage = string.Empty)"></button>
            </div>
        }

        <div class="row">
            <div class="col-lg-4">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Personal Information</h5>
                    </div>
                    <div class="card-body">
                        @if (isEditing)
                        {
                            <EditForm Model="patient" OnValidSubmit="SaveChanges">
                                <DataAnnotationsValidator />
                                
                                <div class="mb-3">
                                    <label class="form-label">Full Name</label>
                                    <InputText @bind-Value="patient.FullName" class="form-control" />
                                    <ValidationMessage For="@(() => patient.FullName)" />
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Date of Birth</label>
                                    <InputDate @bind-Value="patient.DateOfBirth" class="form-control" />
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Gender</label>
                                    <InputSelect @bind-Value="patient.Gender" class="form-select">
                                        <option value="">Select...</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </InputSelect>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <InputText @bind-Value="patient.PhoneNumber" class="form-control" />
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <InputText @bind-Value="patient.Email" type="email" class="form-control" />
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Address</label>
                                    <InputTextArea @bind-Value="patient.Address" class="form-control" rows="2" />
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Emergency Contact</label>
                                    <InputText @bind-Value="patient.EmergencyContact" class="form-control" />
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success" disabled="@isSaving">
                                        @if (isSaving)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        Save
                                    </button>
                                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                                </div>
                            </EditForm>
                        }
                        else
                        {
                            <dl class="row mb-0">
                                <dt class="col-sm-5">Patient ID:</dt>
                                <dd class="col-sm-7">@patient.PatientId</dd>
                                
                                <dt class="col-sm-5">Full Name:</dt>
                                <dd class="col-sm-7">@patient.FullName</dd>
                                
                                <dt class="col-sm-5">Date of Birth:</dt>
                                <dd class="col-sm-7">@patient.DateOfBirth.ToShortDateString() (@CalculateAge(patient.DateOfBirth) years)</dd>
                                
                                <dt class="col-sm-5">Gender:</dt>
                                <dd class="col-sm-7">@patient.Gender</dd>
                                
                                <dt class="col-sm-5">Phone:</dt>
                                <dd class="col-sm-7">@patient.PhoneNumber</dd>
                                
                                <dt class="col-sm-5">Email:</dt>
                                <dd class="col-sm-7">@patient.Email</dd>
                                
                                <dt class="col-sm-5">Address:</dt>
                                <dd class="col-sm-7">@patient.Address</dd>
                                
                                <dt class="col-sm-5">Emergency Contact:</dt>
                                <dd class="col-sm-7">@patient.EmergencyContact</dd>
                            </dl>
                        }
                    </div>
                </div>

                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Medical Information</h5>
                    </div>
                    <div class="card-body">
                        @if (isEditing)
                        {
                            <div class="mb-3">
                                <label class="form-label">Blood Type</label>
                                <InputText @bind-Value="patient.BloodType" class="form-control" />
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Allergies</label>
                                <InputTextArea @bind-Value="patient.Allergies" class="form-control" rows="2" />
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Medical History</label>
                                <InputTextArea @bind-Value="patient.MedicalHistory" class="form-control" rows="3" />
                            </div>
                        }
                        else
                        {
                            <dl class="row mb-0">
                                <dt class="col-sm-5">Blood Type:</dt>
                                <dd class="col-sm-7">@patient.BloodType</dd>
                                
                                <dt class="col-sm-5">Allergies:</dt>
                                <dd class="col-sm-7">@(string.IsNullOrEmpty(patient.Allergies) ? "None" : patient.Allergies)</dd>
                                
                                <dt class="col-sm-12 mt-2">Medical History:</dt>
                                <dd class="col-sm-12">@(string.IsNullOrEmpty(patient.MedicalHistory) ? "None" : patient.MedicalHistory)</dd>
                            </dl>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Appointment History</h5>
                    </div>
                    <div class="card-body">
                        @if (appointments.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Doctor</th>
                                            <th>Status</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var apt in appointments.OrderByDescending(a => a.AppointmentDate).Take(10))
                                        {
                                            <tr>
                                                <td>@apt.AppointmentDate.ToShortDateString()</td>
                                                <td>@apt.AppointmentTime.ToString(@"hh\:mm")</td>
                                                <td>@apt.Doctor?.User?.FullName</td>
                                                <td>
                                                    <span class="badge bg-@GetStatusColor(apt.Status)">
                                                        @apt.Status
                                                    </span>
                                                </td>
                                                <td>@apt.Reason</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center py-3">No appointments found</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Patient? patient;
    private Patient? originalPatient;
    private List<Appointment> appointments = new();
    private bool isLoading = true;
    private bool isEditing = false;
    private bool isSaving = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            patient = await PatientManager.GetPatientByIdAsync(Id);
            
            if (patient != null)
            {
                originalPatient = new Patient
                {
                    PatientId = patient.PatientId,
                    FullName = patient.FullName,
                    DateOfBirth = patient.DateOfBirth,
                    Gender = patient.Gender,
                    PhoneNumber = patient.PhoneNumber,
                    Email = patient.Email,
                    Address = patient.Address,
                    EmergencyContact = patient.EmergencyContact,
                    BloodType = patient.BloodType,
                    Allergies = patient.Allergies,
                    MedicalHistory = patient.MedicalHistory
                };

                appointments = (await AppointmentManager.GetAppointmentsByPatientAsync(Id)).ToList();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading patient: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void EnableEdit()
    {
        isEditing = true;
    }

    private void CancelEdit()
    {
        if (originalPatient != null && patient != null)
        {
            patient.FullName = originalPatient.FullName;
            patient.DateOfBirth = originalPatient.DateOfBirth;
            patient.Gender = originalPatient.Gender;
            patient.PhoneNumber = originalPatient.PhoneNumber;
            patient.Email = originalPatient.Email;
            patient.Address = originalPatient.Address;
            patient.EmergencyContact = originalPatient.EmergencyContact;
            patient.BloodType = originalPatient.BloodType;
            patient.Allergies = originalPatient.Allergies;
            patient.MedicalHistory = originalPatient.MedicalHistory;
        }
        isEditing = false;
        errorMessage = string.Empty;
    }

    private async Task SaveChanges()
    {
        try
        {
            isSaving = true;
            errorMessage = string.Empty;
            
            if (patient != null)
            {
                await PatientManager.UpdatePatientAsync(patient);
                successMessage = "Patient information updated successfully";
                isEditing = false;
                
                originalPatient = new Patient
                {
                    PatientId = patient.PatientId,
                    FullName = patient.FullName,
                    DateOfBirth = patient.DateOfBirth,
                    Gender = patient.Gender,
                    PhoneNumber = patient.PhoneNumber,
                    Email = patient.Email,
                    Address = patient.Address,
                    EmergencyContact = patient.EmergencyContact,
                    BloodType = patient.BloodType,
                    Allergies = patient.Allergies,
                    MedicalHistory = patient.MedicalHistory
                };
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating patient: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private int CalculateAge(DateTime dateOfBirth)
    {
        var today = DateTime.Today;
        var age = today.Year - dateOfBirth.Year;
        if (dateOfBirth.Date > today.AddYears(-age)) age--;
        return age;
    }

    private string GetStatusColor(AppointmentStatus status)
    {
        return status switch
        {
            AppointmentStatus.Scheduled => "primary",
            AppointmentStatus.Confirmed => "info",
            AppointmentStatus.InProgress => "warning",
            AppointmentStatus.Completed => "success",
            AppointmentStatus.Cancelled => "danger",
            AppointmentStatus.NoShow => "secondary",
            _ => "secondary"
        };
    }
}
